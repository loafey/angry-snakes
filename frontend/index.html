<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>battlesnakes.tv</title>
    <style>
        #battlefield {
            display: grid;
        }

        #battlefield>.map-base {
            transition-duration: 100ms;
        }

        #battlefield>.map-slot {
            background-color: lightgray;
            border-radius: 5px;
            margin: 1px;
            display: block;
        }

        #battlefield>.snake {
            border-radius: 0px;
            padding: 1px;
            display: block;
        }

        #battlefield>.snake-head {
            background-color: green;
            border-radius: 5px;
            margin: 1px;
            display: block;
        }

        #battlefield>.snake-head::after {
            content: "üêç";
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #battlefield>.apple {
            background-color: red;
            border-radius: 100%;
            margin: 4px;
            display: block;
        }

        #app {
            display: grid;
            grid-template-columns: auto auto;
        }

        .snake-num-0 {
            background-color: greenyellow;
        }

        .snake-num-1 {
            background-color: yellow;
        }

        .snake-num-2 {
            background-color: red;
        }

        .snake-num-3 {
            background-color: orange;
        }

        .snake-num-4 {
            background-color: teal;
        }

        .snake-num-5 {
            background-color: purple;
        }

        .snake-num-6 {
            background-color: olive;
        }

        .snake-num-7 {
            background-color: navy;
        }

        .snake-num-8 {
            background-color: aqua;
        }

        .snake-num-9 {
            background-color: coral;
        }

        .snake-num-10 {
            background-color: gray;
        }

        .snake-num-11 {
            background-color: hotpink;
        }

        .player-brick {
            min-width: 1rem;
            min-height: 1rem;
            display: inline-block;
        }
    </style>
</head>

<body>
    <div style="display: flex; align-items: center;">
        <h1>battlesnakes.tv</h1>
        &nbsp;
        &nbsp;
        <p>
            ü§ìüëâ <a href="https://github.com/loafey/battlesnakes.tv">source</a>
            <br>
            baked by
            <a href="https://loafey.se">@loafey</a> üêçüçû
        </p>
    </div>
    <div id="app">
        <div id="battlefield">
            <div class="map-slot">a</div>
            <div class="map-slot">b</div>
            <div class="map-slot">c</div>
            <div class="map-slot">d</div>
        </div>
        <div id="scoreboard"></div>
    </div>


    <script>
        const socket = new WebSocket("watch");
        const battlefield = document.getElementById("battlefield");
        const scoreboard = document.getElementById("scoreboard");
        let lastSize = [0, 0];
        let map = [];

        socket.addEventListener("open", (event) => {
            // socket.send("Hello Server!");
        });

        socket.addEventListener("message", (event) => {
            const data = JSON.parse(event.data);
            if (lastSize[0] != data.map_size[0] && lastSize[1] != data.map_size[1]) {
                console.warn(`redraw: ([${lastSize}] != [${data.map_size}])`);
                lastSize = data.map_size;
                map = [];
                battlefield.innerHTML = '';
                battlefield.style.gridTemplateColumns = `repeat(${lastSize[0]}, 32px)`;
                battlefield.style.gridTemplateRows = `repeat(${lastSize[1]}, 32px)`;
                console.log(battlefield.style.gridTemplateRows);
                for (let y = 0; y < lastSize[1]; y++) {
                    for (let x = 0; x < lastSize[0]; x++) {
                        let slot = document.createElement("div");
                        slot.classList.add("map-slot");
                        battlefield.appendChild(slot);
                        map.push(slot);
                    }
                }
            } else {
                let index = 0;
                for (piece of data.map) {
                    let child = map[index];
                    child.className = "map-base";

                    if (piece == "Apple") {
                        child.classList.add("apple");
                    } else if (piece == "Empty") {
                        child.classList.add("map-slot");
                    } else if (piece["Snake"] != null) {
                        child.classList.add("snake");
                        child.classList.add(`snake-num-${piece["Snake"] % 12}`);
                    } else if (piece["SnakeHead"] != null) {
                        child.classList.add("snake-head");
                        child.classList.add(`snake-head-${piece["SnakeHead"] % 12}`);
                    } else {
                        console.log(piece);
                    }
                    index += 1;
                }
            }

            let players = [];
            for (player of data.clients) {
                players.push(player);
            }
            players.sort((a, b) => a.tail_len < b.tail_len);
            scoreboard.innerHTML = "";
            for (player of players) {
                scoreboard.innerHTML += `<div class="player-brick snake-num-${player.id}" ></div> ${player.name}: ${player.tail_len} | ${player.death}<br/>`;
            }
        });
    </script>
</body>

</html>